{"version":3,"file":"Storage.js","sources":["../lib/Storage.js"],"sourcesContent":["export class Storage {\n  constructor (options = {}) {\n    this.documents = new Set()\n    this.keys = new Map()\n\n    this.name = options.name\n    this.primary = options.primary || 'id'\n    this.handler = options.handler\n      ? Array.isArray(options.handler) ? options.handler : [options.handler]\n      : []\n    this.hasInsert = this.handler.find(h => !!h.insert)\n    this.hasUpdate = this.handler.find(h => !!h.update)\n    this.hasRemove = this.handler.find(h => !!h.remove)\n  }\n\n  async insert (documents = []) {\n    documents = Array.isArray(documents) ? documents : [documents]\n    const local = shallowCopies(documents)\n    let primaries = []\n\n    if (this.hasInsert) {\n      const options = getOptions(this)\n\n      // this runs a middleware stack on the shallow copies of the docs\n      // which might even alter the size and the signature of the docs\n      // as long as the last return value is the array with the primary keys\n      // which is also passed as third argument in order to allow\n      // throughput until the end, in case it has been created\n      // before the last handler in the stack\n      for (const handler of this.handler) {\n        if (handler.insert) {\n          primaries = await handler.insert(local, options, primaries)\n        }\n      }\n\n      if (!primaries || primaries.length !== local.length) {\n        throw new Error(`Insert return values expected to be of length (${primaries.length}), got (${local.length}) in storage ${this.name}`)\n      }\n    } else {\n      primaries = local.map(() => incrementKey())\n    }\n\n    local.forEach((doc, index) => {\n      const key = primaries[index]\n      doc[this.primary] = key\n      this.keys.set(key, doc)\n      this.documents.add(doc)\n    })\n\n    local.length = 0\n    return primaries\n  }\n\n  async update (query, modifier, options = {}) {\n    if (this.primary in modifier) {\n      throw new Error(`Unexpected primary in modifier in store ${this.name}`)\n    }\n\n    const local = shallowCopies(this.find(query, options))\n    const entries = Object.entries(modifier)\n    let updated = local.map(doc => {\n      const copy = ({ ...doc })\n\n      entries.forEach(([key, value]) => {\n        const val = typeof value === 'function'\n          ? value(copy[key])\n          : value\n        if (val === null) {\n          delete copy[key]\n        } else if (val !== undefined) {\n          copy[key] = val\n        }\n      })\n      return copy\n    })\n\n    if (this.hasUpdate) {\n      for (const handler of this.handler) {\n        if (handler.update) {\n          updated = await handler.update(local, modifier, options, updated)\n        }\n      }\n\n      if (updated.length !== local.length) {\n        throw new Error(`Update return values expected to be of length (${updated.length}), got (${local.length}) in storage ${this.name}`)\n      }\n    }\n\n    updated.forEach(doc => {\n      const key = doc[this.primary]\n      const original = this.keys.get(key)\n\n      if (!original) {\n        throw new Error(`Doc not found by primary key ${key}`)\n      }\n      this.documents.delete(original)\n      this.documents.add(doc)\n      this.keys.set(key, doc)\n    })\n\n    return updated.length\n  }\n\n  async remove (query, options = {}) {\n    const local = shallowCopies(this.find(query, options))\n    let removed = local.map(doc => doc[this.primary])\n\n    if (this.hasRemove) {\n      const options = getOptions(this)\n\n      for (const handler of this.handler) {\n        if (handler.remove) {\n          removed = await handler.remove(local, options, removed)\n        }\n      }\n      if (removed.length !== local.length) {\n        throw new Error(`Remove return values expected to be of length (${removed.length}), got (${local.length}) in storage ${this.name}`)\n      }\n    }\n\n    removed.forEach(key => {\n      const original = this.keys.get(key)\n\n      if (!original) {\n        throw new Error(`Doc not found by primary key ${key}`)\n      }\n      this.documents.delete(original)\n      this.keys.delete(key)\n    })\n\n    return removed.length\n  }\n\n  find (query, options = {}) {\n    const { limit } = options\n    const docs = this.documents.values()\n\n    if (!query) {\n      return filterDocs({ docs, limit, query: () => true })\n    }\n\n    const queryType = typeof query\n\n    if (queryType === 'string') {\n      // string query is expected to be a primary key\n      const doc = this.keys.get(query)\n      return doc ? [doc] : []\n    }\n\n    if (queryType === 'function') {\n      return filterDocs({ docs, limit, query })\n    }\n\n    if (queryType === 'object') {\n      const { looseMatching } = options\n      const entries = Object.entries(query)\n      if (entries.length === 0) {\n        return filterDocs({ docs, limit, query: () => true })\n      }\n\n      const byMatcher = doc => entries.every(([key, value]) => {\n        return looseMatching\n          ? doc[key] == value // eslint-disable-line\n          : doc[key] === value\n      })\n      return filterDocs({ docs, limit, query: byMatcher })\n    }\n\n    throw new Error(`Unsupported query type \"${queryType}\"`)\n  }\n}\n\nconst shallowCopies = docs => docs.map(doc => ({ ...doc }))\nconst getOptions = ({ primary, name }) => ({ primary, name })\nconst filterDocs = ({ docs, query, limit }) => {\n  const filtered = []\n\n  for (const doc of docs) {\n    if (query(doc)) {\n      filtered.push(doc)\n    }\n    if (limit > 0 && filtered.length >= limit) {\n      return filtered\n    }\n  }\n\n  return filtered\n}\nconst incrementKey = (() => {\n  let count = 0\n  return (length = 16) => (++count).toString(10).padStart(length, '0')\n})()\n"],"names":[],"mappings":"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"}